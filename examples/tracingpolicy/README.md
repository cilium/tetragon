  # Tracing Policy Examples

This folder contains various examples of Tracing Policies. Each example demonstrates different features and capabilities of Tracing Policies.

**Note**: These are example policies and should be thoroughly tested before deploying in a production environment.

**Note2**: Before using these policies, please ensure that your system's kernel supports the specific features you are trying to use. Some Tracing Policy actions may require specific kernel versions or configurations. Failure to do so could result in undefined behavior.

To use these examples, simply copy the YAML configuration of the desired Tracing Policy into your own project or environment. Feel free to modify them as needed.

Below is a table that provides a brief description of each example:

| File Name                           | Description                                                                                                               |
|-------------------------------------|---------------------------------------------------------------------------------------------------------------------------|
| bpf.yaml                            | Monitors the BPF verification process (bpf_check), the allocation of performance events (`security_perf_event_alloc`), and the allocation of BPF maps (`security_bpf_map_alloc`), capturing specific arguments passed to these functions |
| process-credentials/creds-capability-usage.yaml          | Monitors capability checks performed by the kernel when a process tries a privileged operation |
| cves/cve-2023-2640-overlayfs-ubuntu.yaml | Prevents copying up security.capability xattr on overlayfs from a user namespace, making it a nop.|
| datagram-with-selectors.yaml         | Designed to monitor UDP packets directed to loopback addresses within the 127.0.0.1/8 range by hooking into the `__cgroup_bpf_run_filter_skb` kernel function. It provides insights into which processes or cgroups are involved in such transactions, while limiting the trace output to 5 events per second to conserve system resources. |
| datagram.yaml                        | Hooks into the `__cgroup_bpf_run_filter_skb kernel` function to monitor socket buffer (skb) events. It captures details like the type of socket involved, the socket buffer attributes, and an integer value, but it does not specify any filters or rate limits. |
| datagram-518.yaml                        | Datagram monitoring for kernel v5.18 onwards. In 5.18, an extra check was introduced (cgroup_bpf_sock_enabled) which checks if a BPF program is attached to the cgroup hook before calling `__cgroup_bpf_run_filter_skb`. |
| dev_queue_xmit.yaml                  | Hooks into the dev_queue_xmit kernel function to monitor the transmission of socket buffers (skb) in the device queue. It captures the details of the socket buffer being transmitted but does not specify any filters, selectors, or rate limits. |
| dns-only-specified-servers.yaml      | Monitors outbound TCP and UDP connections on port 53 using the ip_output kernel hook. It is configured to report and terminate any process that attempts to connect to a DNS server not on the approved list, specifically any server other than 127.0.0.53, treating such actions as potentially malicious. |
| fd_install_cap_changes.yaml          | Hooks into the fd_install kernel function to monitor file descriptor installations. It is configured to filter events based on changes in effective capabilities, specifically looking for instances where either the `CAP_SYS_ADMIN` or `CAP_NET_RAW` capabilities are involved within a namespace. |
| fd_install_caps.yaml                 | Configured to monitor the `fd_install` kernel function, which is related to the installation of file descriptors. It is designed to trigger when the installation of a file descriptor is associated with either the `CAP_CHOWN` or `CAP_NET_RAW` capabilities within a namespace, providing a way to oversee specific security-sensitive operations related to file and network access. |
| fd_install_ns_host.yaml              | Monitor the `fd_install` system call, focusing specifically on file descriptor installations that occur in the host's PID namespace, identified by the label "host_ns." The policy aims to enhance security and auditing by tracking file descriptor activities exclusively in the host's process namespace. |
| fd_install_ns.yaml                   | This tracing policy targets the `fd_install` system call to monitor file descriptor installations, specifically within the processes running in the Linux namespaces identified by the given namespace IDs for Pid and Mnt. |
| fd_memfd_kill.yaml                   | Monitors three key system calls: `sys_close` for file descriptor closures, `sys_memfd_create` for memory file descriptor creation, and `sys_execve` for new process executions. It is configured to take preventive actions, such as terminating processes that attempt to execute from sensitive paths like `/proc/self/fd/`, thereby providing an additional layer of security against unauthorized or potentially harmful activities. |
| filename_monitoring_filtered.yaml    | This tracing policy is designed to monitor and capture events related to specific file operations on the `/etc/passwd` file |
| filename_monitoring.yaml             | Monitoring file operations within the /etc/ directory, targeting three specific kernel functions: security_file_permission for file read and write permissions, security_mmap_file for memory mapping of files, and security_path_truncate for file truncation. |
| hardlink-observe.yaml                | Configured to monitor the `sys_linkat` system call, specifically looking for any attempt to create hard links to the /etc/passwd file.  |
| hardlink-override.yaml               | This tracing policy targets the `sys_linkat` system call and looks specifically for attempts to create hard links to the `/etc/passwd` file. If such an attempt is detected, the policy overrides the system call, returning an error code of -1, effectively blocking the operation. |
| kprobe_commit_creds.yaml             | This tracing policy focuses on the commit_creds kernel function, which is a crucial part of the Linux privilege model and is used when credentials (like user or group IDs) are about to be committed to a task. By monitoring this function, the policy can help in tracing or auditing changes in process credentials, which is valuable for security analysis or debugging. |
| list-generated-ftrace.yaml           | The ksys_ prefix is often used in the Linux kernel code to indicate a kernel-side implementation of a system call. This policy, "all-ksys-for-kill," is designed to monitor all such kernel-side system call implementations specifically when invoked by the `/usr/bin/kill` command. The goal is to gain a comprehensive understanding of the system calls being triggered by the kill command for debugging, security monitoring, or performance analysis purposes. |
| list-syscalls-generated.yaml          | Monitor all system calls that are triggered by the `/usr/bin/kill` command. It uses a generated list of all syscalls to provide comprehensive coverage. |
| list-syscalls-tracepoint.yaml         | Monitor the `sys_dup` and `sys_dup2` system calls by hooking into the `sys_enter` tracepoint event in the `raw_syscalls` subsystem. It captures the events where either of these duplicate file descriptor syscalls is invoked. |
| list-syscalls.yaml                    | Set up to monitor two specific system calls: `sys_dup` and `sys_dup2`, which are used for duplicating file descriptors. By using a kprobe with the list "syscalls," this policy captures events related to these syscalls, helping to identify any abnormal or unauthorized file descriptor manipulations. |
| loader.yaml                           | The Loader Tracing Policy is special case of standard TracingPolicy. The process_loader event contains information related to loaded binaries and libraries during the process execution. Supported on kernel version >= 5.19.0 |
| names.yaml                            | Monitors and controls file operations on a specific file `/tmp/test`, especially when the operations are carried out by a specific binary `/usr/bin/vim`, and terminates the process if it attempts unauthorized writes. |
| open_dnsrequest.yaml                  | The policy watches for instances where a file descriptor related to the `/etc/passwd` file is being installed, and then actions a DNS request - This example could be crafted for use with canary tokens |
| open_geturl.yaml                      | The policy watches for instances where a file descriptor related to the `/etc/passwd` file is being installed, and then actions a URL request - This example could be crafted for use with canary tokens |
| open_kill.yaml                        | Tracks and terminates process trying to write to `/etc/passwd` |
| openat_write.yaml                     | Monitor the "sys_openat" system call specifically for interactions with the /etc/passwd file. The policy triggers when the system call attempts to create (0x40), write-only (0x1), or read-write (0x2) the file, and it only matches if the return argument (file descriptor) is greater than zero, indicating successful file opening.  |
| process-credentials/process-creds-changed.yaml            | Monitor the kernel functions c`ommit_creds`, `override_creds`, and `revert_creds`, which are responsible for changing, overriding, and reverting the credentials of a process, respectively. The policy is scoped to a specific PID namespace (excluding the host namespace) and aims to catch a variety of credential changes, such as during `execve`, gaining new privileges, and namespace changes, while limiting the rate of generated events to one per minute. |
| process-credentials/process-creds-installed.yaml          | Monitors calls to commit_creds to track new credential installations on tasks. It is limited to a specific PID namespace and has a rate limit of one event per minute for focused security monitoring. |
| process-credentials/process.credentials.changes.at.syscalls.yaml | Monitors credential-changing system calls that in namespaces except `host_ns`. |
| process-exec/process-exec-elf-begin.yaml           | Reports the file path of ELF or flat binaries at the moment they start executing. It does not capture paths for different binary format handlers or scripts but will report the final ELF or flat binary being executed. |
| raw_syscalls.yaml                     | Captures events at the entry point of raw system calls by monitoring the sys_enter event in the raw_syscalls subsystem. |
| symlink-observe.yaml                  | This tracing policy is aimed at monitoring the sys_symlinkat system call, specifically looking for attempts to create symbolic links to the /etc/passwd file. |
| symlink-override.yaml                 | This tracing policy is designed to monitor preventing unauthorized symbolic links to the /etc/passwd file. |
| sys_clock_settime.yaml                | Monitors calls to the sys_clock_settime system call, which is used to set the system time. The policy is configured to ignore events originating from processes with PID 0 or 1 within a PID namespace, and it captures the which_clock argument to the system call as an integer. |
| sys_mount.yaml                        | monitor the sys_mount system call, which is responsible for mounting file systems in Linux. The policy captures the source and target arguments as strings to provide details on what is being mounted and where. |
| sys_pivot_root.yaml                   | Monitors the `sys_pivot_root` system call in Linux, which is used to change the root filesystem of a process. The policy captures the new root and put_old arguments to provide details on the new root filesystem and where the old root is moved, excluding the operations from the init process (PID 1) and the kernel (PID 0). |
| sys_ptrace.yaml                       | Monitoring the `sys_ptrace` system call, which is commonly used for debugging and can control or observe another process. The policy captures the second argument, which usually specifies the target process ID, to provide insights into which processes are being traced or manipulated. |
| sys_setuid.yaml                       | Targets the `setuid` system call, which is used to change the user ID of the calling process. This policy can help track attempts to change process ownership. |
| sys_write_follow_fd_etc_pwd.yaml      | Track attempts to modify `/etc/passwd` file by monitoring `fd_install` and `sys_write`. |
| sys_write_follow_fd_prefix.yaml       | Track file operations in `/etc/` directory, monitors the following; `fd_install`. `sys_close`, `sys_read`, and `sys_write`. |
| sys_write_sigkill.yaml                | Kill any process apart from PID 0 + 1 that attempts to write to `/tmp/passwd`. Monitors the following; `fd_install`, `do_dup2`, `sys_close`, and `sys_write`. |
| tcp-accept.yaml                       | Provide insights into the lifecycle of IPv4 sockets, their state changes, and specific activities like closing a socket |
| tcp-connect-only-local-addrs.yaml     | Monitor and control outbound TCP connections initiated by the `/usr/bin/curl` binary. It kills any curl process that attempts to connect to an IP address outside the local loopback range (127.0.0.0/8). |
| tcp-connect-only-private-addrs.yaml   | Monitors outbound TCP connections initiated by the `/usr/bin/curl` binary, killing any process that tries to connect to IP addresses outside of specified private ranges (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16) and the local loopback (127.0.0.0/8). |
| tcp-connect-with-selectors.yaml       | Tracks TCP connections on Linux by monitoring three key events: `tcp_connect`, `tcp_close`, and `tcp_sendmsg`. The policy is configured to capture these events when the destination address (DAddr) falls within either the loopback range (127.0.0.1/8) or a private IP range (192.168.0.0/16) |
| tcp-connect.yaml                      | Monitor `tcp_connect`, `tcp_close`, and `tcp_sendmsg` |
| tty.yaml                              | This tracing policy is designed to monitor and capture events related to writing to the TTY, which is often associated with terminal I/O operations |
| tty_54.yaml                           | Capture TTY events including file descriptor, character buffer and size of data written. |
| uprobe-binaries.yaml                  | Monitor memory allocation calls made by `usr/bin/bash`  |
| uprobe-host.yaml                      | Track if `/usr/bin/bash` is started at `/procRoot/1/root` |
| uprobe-pid.yaml                       | Monitor readline calls in `/usr/bin/bash` against a specific process and it's forks. |
| uprobe.yaml                           | Track the readline calls in `/bin/bash`. |
| write.yaml                            | Trace the `sys_write` system call, capturing the file descriptor, the buffer being written, and the size of the data. Selector PID is not equal to 1. |
