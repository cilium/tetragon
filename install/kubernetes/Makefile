# SPDX-License-Identifier: Apache-2.0
# Copyright Authors of Cilium
# Copyright Authors of Tetragon

MAKEFILE_VALUES?=Makefile.values
include $(MAKEFILE_VALUES)

include ../../Makefile.defs

TETRAGON_CHART := $(ROOT_DIR)/$(RELATIVE_DIR)/tetragon

VALUES_TMPL_FILE_NAME ?= *values.yaml.tmpl

define generate_values_yaml
echo -e "# File generated by $(RELATIVE_DIR)/Makefile; DO NOT EDIT." > $(2); \
echo -e "# This file is based on $(RELATIVE_DIR)/tetragon/$(VALUES_TMPL_FILE_NAME).\n" >> $(2); \
cat $(1) | envsubst >> $(2)
endef

all: tetragon/values.yaml check-values-yaml

check-values-yaml:
	$(QUIET)( $(call generate_values_yaml,$(TETRAGON_CHART)/$(VALUES_TMPL_FILE_NAME),/dev/stdout) ) \
		| diff -u - "$(TETRAGON_CHART)/values.yaml" \
		|| (echo -e "\nerror: tetragon/values.yaml has been modified"; \
			echo "Make sure to apply your changes to tetragon/$(VALUES_TMPL_FILE_NAME) and run 'make -C install/kubernetes tetragon/values.yaml' to regenerate."; exit 1)

tetragon/values.yaml: $(TETRAGON_CHART)/$(VALUES_TMPL_FILE_NAME) $(ROOT_DIR)/$(RELATIVE_DIR)/$(MAKEFILE_VALUES)
	$(call generate_values_yaml,$(TETRAGON_CHART)/$(VALUES_TMPL_FILE_NAME),$@)

.PHONY: all check-values-yaml tetragon/values.yaml
