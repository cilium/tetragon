// SPDX-License-Identifier: Apache-2.0
// Copyright 2024 Isovalent Inc.

package metricsmd

import (
	"bytes"
	"fmt"
	"io"
	"log/slog"

	"golang.org/x/exp/maps"

	"github.com/prometheus/client_golang/prometheus"
	"github.com/spf13/cobra"
	"github.com/spf13/viper"
)

type targetToHeader map[string]string

type initMetricsFunc func(target string, reg *prometheus.Registry, log *slog.Logger) error

// NewCmd creates a Cobra command for generating metrics reference docs.
// It's intended to be used as an add-on to applications that have a Cobra CLI
// and expose Prometheus metrics.
func NewCmd(vp *viper.Viper, log *slog.Logger, annotations map[string]string,
	targets targetToHeader, overrides []LabelOverrides, initMetrics initMetricsFunc,
) *cobra.Command {
	cmd := &cobra.Command{
		Use:         "metrics-docs",
		Hidden:      true,
		Annotations: annotations,
		ValidArgs:   maps.Keys(targets),
		Args:        cobra.MatchAll(cobra.ExactArgs(1), cobra.OnlyValidArgs),
		PreRunE: func(cmd *cobra.Command, _ []string) error {
			if vp != nil {
				flags := cmd.Flags()
				if err := vp.BindPFlags(flags); err != nil {
					return err
				}
			}
			return nil
		},
		RunE: func(cmd *cobra.Command, args []string) error {
			target := args[0]
			reg := prometheus.NewRegistry()

			err := initMetrics(target, reg, log)
			if err != nil {
				return err
			}

			var b bytes.Buffer
			// Comment to inform people this file is autogenerated.
			b.WriteString("<!-- This file is autogenerated via https://github.com/isovalent/metricstool -->\n\n")
			// Document title
			b.WriteString(fmt.Sprintf("# %s Metrics\n\n", targets[target]))
			// Generate metrics reference
			err = Generate(reg, &b, overrides)
			if err != nil {
				return err
			}
			io.Copy(cmd.OutOrStdout(), &b)

			return nil
		},
	}
	return cmd
}
